agents:
  queue: {{.queue}}
env:
  BUILDKITE_GIT_MIRRORS_PATH: /tmp/buildkite-git-mirrors
steps:
- label: ":git: Write File to Git Mirror Dir"
  key: write-file-to-git-mirror-dir
  plugins:
  - kubernetes:
      podSpec:
        containers:
        - image: alpine:latest
          command: [ash, -c]
          args:
          - |-
            echo volume_mounted > "/tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt"
            cat "/tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt"
        - image: alpine:latest
          command: [ash, -c]
          args:
          - |-
            COUNT=0
            until [[ $$((COUNT++)) == 9 ]]; do
              grep -Fx volume_mounted "/tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt" && break
              echo "Waiting for 'volume_mounted' to be written to /tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt"
              sleep 1
            done

            if ! grep -Fx volume_mounted "/tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt"; then
              echo "'volume_mounted' has not been written to /tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt"
              exit 1
            fi

            echo "'volume_mounted' has been written to /tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt"
            rm -f "/tmp/buildkite-git-mirrors/foo-$${BUILDKITE_JOB_ID}.txt"
        volumes:
        - name: host-volume
          hostPath:
            path: /tmp/volumes/{{.queue}}
            type: DirectoryOrCreate
      extraVolumeMounts:
      - name: host-volume
        mountPath: /tmp/buildkite-git-mirrors
        subPath: buildkite-git-mirrors
